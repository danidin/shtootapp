<!DOCTYPE html>
<html>
<head>
  <script>
    if (!localStorage.getItem('jwt')) {
      window.location = '/peh/login'
    }
  </script>
  <script type="module">
      class ShtootPeh extends HTMLElement {
      constructor() {
        super();
        this.attachShadow({ mode: 'open' });
        this.shtoots = [];
        this.jwt = localStorage.getItem('jwt');
        this.userID = this.decodeJwtResponse(this.jwt).email;
        this.space = this._getSpaceFromRoute();
        this.isDev = new URLSearchParams(window.location.search).get('dev') === 'true';
        this.apiUrl = this.isDev ? 'http://localhost:4000/graphql' : 'https://api.shtoot.net/graphql';
        this.wsUrl = this.isDev ? 'ws://localhost:4000/graphql' : 'wss://api.shtoot.net/graphql';
        this.ws = null;
        this.subscribed = false;
        this.shadowRoot.innerHTML = `
          <style>
            .shtoots { border: 1px solid #ccc; max-height: 200px; overflow-y: auto; margin-bottom: 10px; background: #f8f8fa; padding: 6px; font-family: sans-serif; }
            .shtoot { border-bottom: 1px solid #eee; padding: 3px 0; }
            textarea { width: 100%; min-height: 2.5em; font-family: inherit; margin-bottom: 0.5em; }
            button { margin-top: 2px; }
            .meta { font-size: 0.8em; color: #888; }
            .error { color: red; font-size: 0.9em; }
          </style>
          <div class="shtoots"></div>
          <textarea placeholder="Say a Shtoot..."></textarea><br/>
          <button>Send</button>
          <div class="error"></div>
        `;
      }
    
      connectedCallback() {
        this.textarea = this.shadowRoot.querySelector('textarea');
        this.listEl = this.shadowRoot.querySelector('.shtoots');
        this.errorEl = this.shadowRoot.querySelector('.error');
        this.shadowRoot.querySelector('button').onclick = () => this._createShtoot();
        this._connectWs();
      }
    
      disconnectedCallback() {
        if (this.ws) this.ws.close();
      }

      decodeJwtResponse(token) {
        let base64Url = token.split('.')[1];
        let base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        let jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));

        return JSON.parse(jsonPayload);
      }

      _getSpaceFromRoute() {
        const params = new URLSearchParams(window.location.search);
        return params.get('space');
      }
    
      _renderShtoots() {
        const filtered = this.shtoots.filter(s => s.space === this.space);
        this.listEl.innerHTML = filtered.map(s =>
          `<div class="shtoot">
            <span>${this._escapeHtml(s.text)}</span>
            <div class="meta">${this._escapeHtml(s.userID)} @ ${new Date(Number(s.timestamp)).toLocaleTimeString()}</div>
          </div>`
        ).join('');
        this.listEl.scrollTop = this.listEl.scrollHeight;
      }
    
      _escapeHtml(str) {
        return String(str).replace(/[&<>"']/g, s => (
          { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s] || s
        ));
      }
    
      _connectWs() {
        this.ws = new WebSocket(this.wsUrl, 'graphql-transport-ws');
        this.ws.onopen = () => {
          this.ws.send(JSON.stringify({
            type: 'connection_init',
            payload: { Authorization: `Bearer ${this.jwt}` }
          }));
        };
        this.ws.onmessage = (event) => {
          try {
            const msg = JSON.parse(event.data);
            if (msg.type === 'connection_ack' && !this.subscribed) {
              this.ws.send(JSON.stringify({
                id: '1',
                type: 'subscribe',
                payload: {
                  query: `subscription { shtootAdded { ID userID text timestamp space } }`
                }
              }));
              this.subscribed = true;
            }
            if (msg.type === 'next' && msg.id === '1' && msg.payload && msg.payload.data && msg.payload.data.shtootAdded) {
              this.shtoots.push(msg.payload.data.shtootAdded);
              this._renderShtoots();
            }
            if (msg.type === 'complete') {
              this.errorEl.textContent = 'Subscription ended';
            }
            if (msg.type === 'error') {
              this.errorEl.textContent = 'Subscription error: ' + JSON.stringify(msg.payload);
            }
          } catch (e) {
            this.errorEl.textContent = 'Bad WS message: ' + e;
          }
        };
        this.ws.onerror = (e) => {
          this.errorEl.textContent = 'WebSocket error';
        };
        this.ws.onclose = (e) => {
          this.errorEl.textContent = 'WebSocket closed: ' + (e.reason || e.code);
        };
      }
    
      async _createShtoot() {
        const text = this.textarea.value.trim();
        this.errorEl.textContent = '';
        if (!text) return;
        try {
          const res = await fetch(this.apiUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${this.jwt}`
            },
            body: JSON.stringify({
              query: `mutation($userID: ID!, $text: String!, $space: String) {
                createShtoot(userID: $userID, text: $text, space: $space) { ID userID text timestamp }
              }`,
              variables: { userID: this.userID, text, space: this.space },
            }),
          });
          const json = await res.json();
          if (json.errors) {
            this.errorEl.textContent = json.errors[0].message;
          } else {
            this.textarea.value = '';
            // (No need to push, WS will update.)
          }
        } catch (err) {
          this.errorEl.textContent = 'Network error: ' + err;
        }
      }
    }
    
    customElements.define('shtoot-peh', ShtootPeh);

    class ShtootSpaceSelector extends HTMLElement {
      constructor() {
        super();
        this.attachShadow({ mode: 'open' });
        this.shtoots = [];
        this.jwt = localStorage.getItem('jwt');
        this.userID = this.decodeJwtResponse(this.jwt).email;
        this.isDev = new URLSearchParams(window.location.search).get('dev') === 'true';
        this.wsUrl = this.isDev ? 'ws://localhost:4000/graphql' : 'wss://api.shtoot.net/graphql';
        this.ws = null;
        this.subscribed = false;
        this.shadowRoot.innerHTML = `
          <style>
            :host { display: block; }
            .space-list { list-style: none; margin: 0; padding: 0; font-family: sans-serif; }
            .space-item { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee; }
            .space-item:hover { background: #f0f0f0; }
            .space-item.active { background: #e0e7ff; }
          </style>
          <ul class="space-list"></ul>
        `;
      }

      connectedCallback() {
        this.listEl = this.shadowRoot.querySelector('.space-list');
        this._connectWs();
      }

      disconnectedCallback() {
        if (this.ws) this.ws.close();
      }

      decodeJwtResponse(token) {
        let base64Url = token.split('.')[1];
        let base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        let jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
      }

      _getSpaces() {
        const spaces = new Set();
        this.shtoots.forEach(s => {
          if (s.space) spaces.add(s.space);
        });
        return Array.from(spaces);
      }

      _formatSpaceTitle(space) {
        return space
          .split(',')
          .filter(email => email.trim() !== this.userID)
          .join(', ') || space;
      }

      _renderSpaces() {
        const currentSpace = new URLSearchParams(window.location.search).get('space');
        const spaces = this._getSpaces();
        this.listEl.innerHTML = spaces.map(space => {
          const isActive = space === currentSpace ? 'active' : '';
          const title = this._escapeHtml(this._formatSpaceTitle(space));
          return `<li class="space-item ${isActive}" data-space="${this._escapeHtml(space)}">${title}</li>`;
        }).join('');

        this.listEl.querySelectorAll('.space-item').forEach(item => {
          item.onclick = () => {
            const space = item.dataset.space;
            const params = new URLSearchParams(window.location.search);
            params.set('space', space);
            window.location.search = params.toString();
          };
        });
      }

      _escapeHtml(str) {
        return String(str).replace(/[&<>"']/g, s => (
          { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s] || s
        ));
      }

      _connectWs() {
        this.ws = new WebSocket(this.wsUrl, 'graphql-transport-ws');
        this.ws.onopen = () => {
          this.ws.send(JSON.stringify({
            type: 'connection_init',
            payload: { Authorization: `Bearer ${this.jwt}` }
          }));
        };
        this.ws.onmessage = (event) => {
          try {
            const msg = JSON.parse(event.data);
            if (msg.type === 'connection_ack' && !this.subscribed) {
              this.ws.send(JSON.stringify({
                id: '1',
                type: 'subscribe',
                payload: {
                  query: `subscription { shtootAdded { ID userID text timestamp space } }`
                }
              }));
              this.subscribed = true;
            }
            if (msg.type === 'next' && msg.id === '1' && msg.payload && msg.payload.data && msg.payload.data.shtootAdded) {
              this.shtoots.push(msg.payload.data.shtootAdded);
              this._renderSpaces();
            }
          } catch (e) {
            console.error('ShtootSpaceSelector WS error:', e);
          }
        };
        this.ws.onerror = (e) => console.error('WebSocket error', e);
        this.ws.onclose = (e) => console.log('WebSocket closed', e.code);
      }
    }

    customElements.define('shtoot-space-selector', ShtootSpaceSelector);

    class ShtootUser extends HTMLElement {
      constructor() {
        super();
        this.attachShadow({ mode: 'open' });
        this.jwt = localStorage.getItem('jwt');
        const payload = this.decodeJwtResponse(this.jwt);
        this.email = payload.email;
        this.name = payload.name || this.email;
        this.picture = payload.picture;
        this.shadowRoot.innerHTML = `
          <style>
            :host { display: block; }
            .user-badge {
              display: flex;
              align-items: center;
              gap: 10px;
              padding: 12px;
              font-family: sans-serif;
            }
            .avatar {
              width: 40px;
              height: 40px;
              border-radius: 50%;
              background: #ccc;
            }
            .user-info {
              display: flex;
              flex-direction: column;
            }
            .user-name {
              font-weight: 500;
              font-size: 14px;
            }
            .user-email {
              font-size: 12px;
              color: #666;
            }
            button {
              margin-top: 8px;
              padding: 6px 12px;
              cursor: pointer;
              border: 1px solid #ccc;
              background: #fff;
              border-radius: 4px;
            }
            button:hover {
              background: #f0f0f0;
            }
          </style>
          <div class="user-badge">
            ${this.picture ? `<img class="avatar" src="${this._escapeHtml(this.picture)}" alt="avatar">` : '<div class="avatar"></div>'}
            <div class="user-info">
              <span class="user-name">${this._escapeHtml(this.name)}</span>
              <span class="user-email">${this._escapeHtml(this.email)}</span>
            </div>
          </div>
          <button id="logout">Log Out</button>
        `;
      }

      connectedCallback() {
        this.shadowRoot.getElementById('logout').onclick = () => {
          localStorage.setItem('jwt', '');
          window.location = '/peh/login';
        };
      }

      decodeJwtResponse(token) {
        let base64Url = token.split('.')[1];
        let base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        let jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
      }

      _escapeHtml(str) {
        return String(str).replace(/[&<>"']/g, s => (
          { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s] || s
        ));
      }
    }

    customElements.define('shtoot-user', ShtootUser);
  </script>
</head>
<body style="margin: 0; display: flex; height: 100vh;">
  <aside style="width: 250px; border-right: 1px solid #ccc; overflow-y: auto;">
    <shtoot-space-selector></shtoot-space-selector>
  </aside>
  <main style="flex: 1; padding: 16px;">
    <shtoot-peh></shtoot-peh>
  </main>
  <aside style="width: 200px; border-left: 1px solid #ccc; padding: 12px;">
    <shtoot-user></shtoot-user>
  </aside>
</body>
</html>